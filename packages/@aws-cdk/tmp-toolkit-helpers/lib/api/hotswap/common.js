"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EcsHotswapProperties = exports.HotswapPropertyOverrides = exports.HotswapMode = exports.ICON = void 0;
exports.classifyChanges = classifyChanges;
exports.nonHotswappableChange = nonHotswappableChange;
exports.nonHotswappableResource = nonHotswappableResource;
const hotswap_1 = require("../../payloads/hotswap");
const toolkit_error_1 = require("../toolkit-error");
exports.ICON = 'âœ¨';
var HotswapMode;
(function (HotswapMode) {
    /**
     * Will fall back to CloudFormation when a non-hotswappable change is detected
     */
    HotswapMode["FALL_BACK"] = "fall-back";
    /**
     * Will not fall back to CloudFormation when a non-hotswappable change is detected
     */
    HotswapMode["HOTSWAP_ONLY"] = "hotswap-only";
    /**
     * Will not attempt to hotswap anything and instead go straight to CloudFormation
     */
    HotswapMode["FULL_DEPLOYMENT"] = "full-deployment";
})(HotswapMode || (exports.HotswapMode = HotswapMode = {}));
/**
 * Represents configuration property overrides for hotswap deployments
 */
class HotswapPropertyOverrides {
    // Each supported resource type will have its own properties. Currently this is ECS
    ecsHotswapProperties;
    constructor(ecsHotswapProperties) {
        this.ecsHotswapProperties = ecsHotswapProperties;
    }
}
exports.HotswapPropertyOverrides = HotswapPropertyOverrides;
/**
 * Represents configuration properties for ECS hotswap deployments
 */
class EcsHotswapProperties {
    // The lower limit on the number of your service's tasks that must remain in the RUNNING state during a deployment, as a percentage of the desiredCount
    minimumHealthyPercent;
    // The upper limit on the number of your service's tasks that are allowed in the RUNNING or PENDING state during a deployment, as a percentage of the desiredCount
    maximumHealthyPercent;
    constructor(minimumHealthyPercent, maximumHealthyPercent) {
        if (minimumHealthyPercent !== undefined && minimumHealthyPercent < 0) {
            throw new toolkit_error_1.ToolkitError('hotswap-ecs-minimum-healthy-percent can\'t be a negative number');
        }
        if (maximumHealthyPercent !== undefined && maximumHealthyPercent < 0) {
            throw new toolkit_error_1.ToolkitError('hotswap-ecs-maximum-healthy-percent can\'t be a negative number');
        }
        // In order to preserve the current behaviour, when minimumHealthyPercent is not defined, it will be set to the currently default value of 0
        if (minimumHealthyPercent == undefined) {
            this.minimumHealthyPercent = 0;
        }
        else {
            this.minimumHealthyPercent = minimumHealthyPercent;
        }
        this.maximumHealthyPercent = maximumHealthyPercent;
    }
    /**
     * Check if any hotswap properties are defined
     * @returns true if all properties are undefined, false otherwise
     */
    isEmpty() {
        return this.minimumHealthyPercent === 0 && this.maximumHealthyPercent === undefined;
    }
}
exports.EcsHotswapProperties = EcsHotswapProperties;
class ClassifiedChanges {
    change;
    hotswappableProps;
    nonHotswappableProps;
    constructor(change, hotswappableProps, nonHotswappableProps) {
        this.change = change;
        this.hotswappableProps = hotswappableProps;
        this.nonHotswappableProps = nonHotswappableProps;
    }
    reportNonHotswappablePropertyChanges(ret) {
        const nonHotswappablePropNames = Object.keys(this.nonHotswappableProps);
        if (nonHotswappablePropNames.length > 0) {
            const tagOnlyChange = nonHotswappablePropNames.length === 1 && nonHotswappablePropNames[0] === 'Tags';
            const reason = tagOnlyChange ? hotswap_1.NonHotswappableReason.TAGS : hotswap_1.NonHotswappableReason.PROPERTIES;
            const description = tagOnlyChange ? 'Tags are not hotswappable' : `resource properties '${nonHotswappablePropNames}' are not hotswappable on this resource type`;
            ret.push(nonHotswappableChange(this.change, reason, description, this.nonHotswappableProps));
        }
    }
    get namesOfHotswappableProps() {
        return Object.keys(this.hotswappableProps);
    }
}
function classifyChanges(xs, hotswappablePropNames) {
    const hotswappableProps = {};
    const nonHotswappableProps = {};
    for (const [name, propDiff] of Object.entries(xs.propertyUpdates)) {
        if (hotswappablePropNames.includes(name)) {
            hotswappableProps[name] = propDiff;
        }
        else {
            nonHotswappableProps[name] = propDiff;
        }
    }
    return new ClassifiedChanges(xs, hotswappableProps, nonHotswappableProps);
}
function nonHotswappableChange(change, reason, description, nonHotswappableProps, hotswapOnlyVisible = true) {
    return {
        hotswappable: false,
        hotswapOnlyVisible,
        change: {
            reason,
            description,
            subject: {
                type: 'Resource',
                logicalId: change.logicalId,
                resourceType: change.newValue.Type,
                rejectedProperties: Object.keys(nonHotswappableProps ?? change.propertyUpdates),
                metadata: change.metadata,
            },
        },
    };
}
function nonHotswappableResource(change) {
    return {
        hotswappable: false,
        change: {
            reason: hotswap_1.NonHotswappableReason.RESOURCE_UNSUPPORTED,
            description: 'This resource type is not supported for hotswap deployments',
            subject: {
                type: 'Resource',
                logicalId: change.logicalId,
                resourceType: change.newValue.Type,
                rejectedProperties: Object.keys(change.propertyUpdates),
                metadata: change.metadata,
            },
        },
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FwaS9ob3Rzd2FwL2NvbW1vbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFpSkEsMENBYUM7QUFFRCxzREFzQkM7QUFFRCwwREFlQztBQXJNRCxvREFBK0Q7QUFFL0Qsb0RBQWdEO0FBRW5DLFFBQUEsSUFBSSxHQUFHLEdBQUcsQ0FBQztBQTZDeEIsSUFBWSxXQWVYO0FBZkQsV0FBWSxXQUFXO0lBQ3JCOztPQUVHO0lBQ0gsc0NBQXVCLENBQUE7SUFFdkI7O09BRUc7SUFDSCw0Q0FBNkIsQ0FBQTtJQUU3Qjs7T0FFRztJQUNILGtEQUFtQyxDQUFBO0FBQ3JDLENBQUMsRUFmVyxXQUFXLDJCQUFYLFdBQVcsUUFldEI7QUFFRDs7R0FFRztBQUNILE1BQWEsd0JBQXdCO0lBQ25DLG1GQUFtRjtJQUNuRixvQkFBb0IsQ0FBd0I7SUFFNUMsWUFBb0Isb0JBQTJDO1FBQzdELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztJQUNuRCxDQUFDO0NBQ0Y7QUFQRCw0REFPQztBQUVEOztHQUVHO0FBQ0gsTUFBYSxvQkFBb0I7SUFDL0IsdUpBQXVKO0lBQzlJLHFCQUFxQixDQUFVO0lBQ3hDLGtLQUFrSztJQUN6SixxQkFBcUIsQ0FBVTtJQUV4QyxZQUFvQixxQkFBOEIsRUFBRSxxQkFBOEI7UUFDaEYsSUFBSSxxQkFBcUIsS0FBSyxTQUFTLElBQUkscUJBQXFCLEdBQUcsQ0FBQyxFQUFHLENBQUM7WUFDdEUsTUFBTSxJQUFJLDRCQUFZLENBQUMsaUVBQWlFLENBQUMsQ0FBQztRQUM1RixDQUFDO1FBQ0QsSUFBSSxxQkFBcUIsS0FBSyxTQUFTLElBQUkscUJBQXFCLEdBQUcsQ0FBQyxFQUFHLENBQUM7WUFDdEUsTUFBTSxJQUFJLDRCQUFZLENBQUMsaUVBQWlFLENBQUMsQ0FBQztRQUM1RixDQUFDO1FBQ0QsNElBQTRJO1FBQzVJLElBQUkscUJBQXFCLElB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QyxTQUFTO2dCQUMzQixZQUFZLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJO2dCQUNsQyxrQkFBa0IsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixJQUFJLE1BQU0sQ0FBQyxlQUFlLENBQUM7Z0JBQy9FLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUTthQUMxQjtTQUNGO0tBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFnQix1QkFBdUIsQ0FBQyxNQUFzQjtJQUM1RCxPQUFPO1FBQ0wsWUFBWSxFQUFFLEtBQUs7UUFDbkIsTUFBTSxFQUFFO1lBQ04sTUFBTSxFQUFFLCtCQUFxQixDQUFDLG9CQUFvQjtZQUNsRCxXQUFXLEVBQUUsNkRBQTZEO1lBQzFFLE9BQU8sRUFBRTtnQkFDUCxJQUFJLEVBQUUsVUFBVTtnQkFDaEIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO2dCQUMzQixZQUFZLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJO2dCQUNsQyxrQkFBa0IsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7Z0JBQ3ZELFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUTthQUMxQjtTQUNGO0tBQ0YsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFByb3BlcnR5RGlmZmVyZW5jZSB9IGZyb20gJ0Bhd3MtY2RrL2Nsb3VkZm9ybWF0aW9uLWRpZmYnO1xuaW1wb3J0IHR5cGUgeyBIb3Rzd2FwcGFibGVDaGFuZ2UsIE5vbkhvdHN3YXBwYWJsZUNoYW5nZSwgUmVzb3VyY2VDaGFuZ2UgfSBmcm9tICcuLi8uLi9wYXlsb2Fkcy9ob3Rzd2FwJztcbmltcG9ydCB7IE5vbkhvdHN3YXBwYWJsZVJlYXNvbiB9IGZyb20gJy4uLy4uL3BheWxvYWRzL2hvdHN3YXAnO1xuaW1wb3J0IHR5cGUgeyBTREsgfSBmcm9tICcuLi9hd3MtYXV0aCc7XG5pbXBvcnQgeyBUb29sa2l0RXJyb3IgfSBmcm9tICcuLi90b29sa2l0LWVycm9yJztcblxuZXhwb3J0IGNvbnN0IElDT04gPSAn4pyoJztcblxuZXhwb3J0IGludGVyZmFjZSBIb3Rzd2FwT3BlcmF0aW9uIHtcbiAgLyoqXG4gICAqIE1hcmtzIHRoZSBvcGVyYXRpb24gYXMgaG90c3dhcHBhYmxlXG4gICAqL1xuICByZWFkb25seSBob3Rzd2FwcGFibGU6IHRydWU7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlIGJlaW5nIGhvdHN3YXBwZWQuXG4gICAqIFVzZWQgdG8gc2V0IGEgY3VzdG9tIFVzZXItQWdlbnQgZm9yIFNESyBjYWxscy5cbiAgICovXG4gIHJlYWRvbmx5IHNlcnZpY2U6IHN0cmluZztcblxuICAvKipcbiAgICogRGVzY3JpcHRpb24gb2YgdGhlIGNoYW5nZSB0aGF0IGlzIGFwcGxpZWQgYXMgcGFydCBvZiB0aGUgb3BlcmF0aW9uXG4gICAqL1xuICByZWFkb25seSBjaGFuZ2U6IEhvdHN3YXBwYWJsZUNoYW5nZTtcblxuICAvKipcbiAgICogQXBwbGllcyB0aGUgaG90c3dhcCBvcGVyYXRpb25cbiAgICovXG4gIHJlYWRvbmx5IGFwcGx5OiAoc2RrOiBTREspID0+IFByb21pc2U8dm9pZD47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVqZWN0ZWRDaGFuZ2Uge1xuICAvKipcbiAgICogTWFya3MgdGhlIGNoYW5nZSBhcyBub3QgaG90c3dhcHBhYmxlXG4gICAqL1xuICByZWFkb25seSBob3Rzd2FwcGFibGU6IGZhbHNlO1xuICAvKipcbiAgICogVGhlIGNoYW5nZSB0aGF0IGdvdCByZWplY3RlZFxuICAgKi9cbiAgcmVhZG9ubHkgY2hhbmdlOiBOb25Ib3Rzd2FwcGFibGVDaGFuZ2U7XG4gIC8qKlxuICAgKiBXaGV0aGVyIG9yIG5vdCB0byBzaG93IHRoaXMgY2hhbmdlIHdoZW4gbGlzdGluZyBub24taG90c3dhcHBhYmxlIGNoYW5nZXMgaW4gSE9UU1dBUF9PTkxZIG1vZGUuIERvZXMgbm90IGFmZmVjdFxuICAgKiBsaXN0aW5nIGluIEZBTExfQkFDSyBtb2RlLlxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSBob3Rzd2FwT25seVZpc2libGU/OiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSBIb3Rzd2FwQ2hhbmdlID0gSG90c3dhcE9wZXJhdGlvbiB8IFJlamVjdGVkQ2hhbmdlO1xuXG5leHBvcnQgZW51bSBIb3Rzd2FwTW9kZSB7XG4gIC8qKlxuICAgKiBXaWxsIGZhbGwgYmFjayB0byBDbG91ZEZvcm1hdGlvbiB3aGVuIGEgbm9uLWhvdHN3YXBwYWJsZSBjaGFuZ2UgaXMgZGV0ZWN0ZWRcbiAgICovXG4gIEZBTExfQkFDSyA9ICdmYWxsLWJhY2snLFxuXG4gIC8qKlxuICAgKiBXaWxsIG5vdCBmYWxsIGJhY2sgdG8gQ2xvdWRGb3JtYXRpb24gd2hlbiBhIG5vbi1ob3Rzd2FwcGFibGUgY2hhbmdlIGlzIGRldGVjdGVkXG4gICAqL1xuICBIT1RTV0FQX09OTFkgPSAnaG90c3dhcC1vbmx5JyxcblxuICAvKipcbiAgICogV2lsbCBub3QgYXR0ZW1wdCB0byBob3Rzd2FwIGFueXRoaW5nIGFuZCBpbnN0ZWFkIGdvIHN0cmFpZ2h0IHRvIENsb3VkRm9ybWF0aW9uXG4gICAqL1xuICBGVUxMX0RFUExPWU1FTlQgPSAnZnVsbC1kZXBsb3ltZW50Jyxcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIGNvbmZpZ3VyYXRpb24gcHJvcGVydHkgb3ZlcnJpZGVzIGZvciBob3Rzd2FwIGRlcGxveW1lbnRzXG4gKi9cbmV4cG9ydCBjbGFzcyBIb3Rzd2FwUHJvcGVydHlPdmVycmlkZXMge1xuICAvLyBFYWNoIHN1cHBvcnRlZCByZXNvdXJjZSB0eXBlIHdpbGwgaGF2ZSBpdHMgb3duIHByb3BlcnRpZXMuIEN1cnJlbnRseSB0aGlzIGlzIEVDU1xuICBlY3NIb3Rzd2FwUHJvcGVydGllcz86IEVjc0hvdHN3YXBQcm9wZXJ0aWVzO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3RvciAoZWNzSG90c3dhcFByb3BlcnRpZXM/OiBFY3NIb3Rzd2FwUHJvcGVydGllcykge1xuICAgIHRoaXMuZWNzSG90c3dhcFByb3BlcnRpZXMgPSBlY3NIb3Rzd2FwUHJvcGVydGllcztcbiAgfVxufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgY29uZmlndXJhdGlvbiBwcm9wZXJ0aWVzIGZvciBFQ1MgaG90c3dhcCBkZXBsb3ltZW50c1xuICovXG5leHBvcnQgY2xhc3MgRWNzSG90c3dhcFByb3BlcnRpZXMge1xuICAvLyBUaGUgbG93ZXIgbGltaXQgb24gdGhlIG51bWJlciBvZiB5b3VyIHNlcnZpY2UncyB0YXNrcyB0aGF0IG11c3QgcmVtYWluIGluIHRoZSBSVU5OSU5HIHN0YXRlIGR1cmluZyBhIGRlcGxveW1lbnQsIGFzIGEgcGVyY2VudGFnZSBvZiB0aGUgZGVzaXJlZENvdW50XG4gIHJlYWRvbmx5IG1pbmltdW1IZWFsdGh5UGVyY2VudD86IG51bWJlcjtcbiAgLy8gVGhlIHVwcGVyIGxpbWl0IG9uIHRoZSBudW1iZXIgb2YgeW91ciBzZXJ2aWNlJ3MgdGFza3MgdGhhdCBhcmUgYWxsb3dlZCBpbiB0aGUgUlVOTklORyBvciBQRU5ESU5HIHN0YXRlIGR1cmluZyBhIGRlcGxveW1lbnQsIGFzIGEgcGVyY2VudGFnZSBvZiB0aGUgZGVzaXJlZENvdW50XG4gIHJlYWRvbmx5IG1heGltdW1IZWFsdGh5UGVyY2VudD86IG51bWJlcjtcblxuICBwdWJsaWMgY29uc3RydWN0b3IgKG1pbmltdW1IZWFsdGh5UGVyY2VudD86IG51bWJlciwgbWF4aW11bUhlYWx0aHlQZXJjZW50PzogbnVtYmVyKSB7XG4gICAgaWYgKG1pbmltdW1IZWFsdGh5UGVyY2VudCAhPT0gdW5kZWZpbmVkICYmIG1pbmltdW1IZWFsdGh5UGVyY2VudCA8IDAgKSB7XG4gICAgICB0aHJvdyBuZXcgVG9vbGtpdEVycm9yKCdob3Rzd2FwLWVjcy1taW5pbXVtLWhlYWx0aHktcGVyY2VudCBjYW5cXCd0IGJlIGEgbmVnYXRpdmUgbnVtYmVyJyk7XG4gICAgfVxuICAgIGlmIChtYXhpbXVtSGVhbHRoeVBlcmNlbnQgIT09IHVuZGVmaW5lZCAmJiBtYXhpbXVtSGVhbHRoeVBlcmNlbnQgPCAwICkge1xuICAgICAgdGhyb3cgbmV3IFRvb2xraXRFcnJvcignaG90c3dhcC1lY3MtbWF4aW11bS1oZWFsdGh5LXBlcmNlbnQgY2FuXFwndCBiZSBhIG5lZ2F0aXZlIG51bWJlcicpO1xuICAgIH1cbiAgICAvLyBJbiBvcmRlciB0byBwcmVzZXJ2ZSB0aGUgY3VycmVudCBiZWhhdmlvdXIsIHdoZW4gbWluaW11bUhlYWx0aHlQZXJjZW50IGlzIG5vdCBkZWZpbmVkLCBpdCB3aWxsIGJlIHNldCB0byB0aGUgY3VycmVudGx5IGRlZmF1bHQgdmFsdWUgb2YgMFxuICAgIGlmIChtaW5pbXVtSGVhbHRoeVBlcmNlbnQgPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLm1pbmltdW1IZWFsdGh5UGVyY2VudCA9IDA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWluaW11bUhlYWx0aHlQZXJjZW50ID0gbWluaW11bUhlYWx0aHlQZXJjZW50O1xuICAgIH1cbiAgICB0aGlzLm1heGltdW1IZWFsdGh5UGVyY2VudCA9IG1heGltdW1IZWFsdGh5UGVyY2VudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBhbnkgaG90c3dhcCBwcm9wZXJ0aWVzIGFyZSBkZWZpbmVkXG4gICAqIEByZXR1cm5zIHRydWUgaWYgYWxsIHByb3BlcnRpZXMgYXJlIHVuZGVmaW5lZCwgZmFsc2Ugb3RoZXJ3aXNlXG4gICAqL1xuICBwdWJsaWMgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5taW5pbXVtSGVhbHRoeVBlcmNlbnQgPT09IDAgJiYgdGhpcy5tYXhpbXVtSGVhbHRoeVBlcmNlbnQgPT09IHVuZGVmaW5lZDtcbiAgfVxufVxuXG50eXBlIFByb3BEaWZmcyA9IFJlY29yZDxzdHJpbmcsIFByb3BlcnR5RGlmZmVyZW5jZTxhbnk+PjtcblxuY2xhc3MgQ2xhc3NpZmllZENoYW5nZXMge1xuICBwdWJsaWMgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWRvbmx5IGNoYW5nZTogUmVzb3VyY2VDaGFuZ2UsXG4gICAgcHVibGljIHJlYWRvbmx5IGhvdHN3YXBwYWJsZVByb3BzOiBQcm9wRGlmZnMsXG4gICAgcHVibGljIHJlYWRvbmx5IG5vbkhvdHN3YXBwYWJsZVByb3BzOiBQcm9wRGlmZnMsXG4gICkge1xuICB9XG5cbiAgcHVibGljIHJlcG9ydE5vbkhvdHN3YXBwYWJsZVByb3BlcnR5Q2hhbmdlcyhyZXQ6IEhvdHN3YXBDaGFuZ2VbXSk6IHZvaWQge1xuICAgIGNvbnN0IG5vbkhvdHN3YXBwYWJsZVByb3BOYW1lcyA9IE9iamVjdC5rZXlzKHRoaXMubm9uSG90c3dhcHBhYmxlUHJvcHMpO1xuICAgIGlmIChub25Ib3Rzd2FwcGFibGVQcm9wTmFtZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgdGFnT25seUNoYW5nZSA9IG5vbkhvdHN3YXBwYWJsZVByb3BOYW1lcy5sZW5ndGggPT09IDEgJiYgbm9uSG90c3dhcHBhYmxlUHJvcE5hbWVzWzBdID09PSAnVGFncyc7XG4gICAgICBjb25zdCByZWFzb24gPSB0YWdPbmx5Q2hhbmdlID8gTm9uSG90c3dhcHBhYmxlUmVhc29uLlRBR1MgOiBOb25Ib3Rzd2FwcGFibGVSZWFzb24uUFJPUEVSVElFUztcbiAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gdGFnT25seUNoYW5nZSA/ICdUYWdzIGFyZSBub3QgaG90c3dhcHBhYmxlJyA6IGByZXNvdXJjZSBwcm9wZXJ0aWVzICcke25vbkhvdHN3YXBwYWJsZVByb3BOYW1lc30nIGFyZSBub3QgaG90c3dhcHBhYmxlIG9uIHRoaXMgcmVzb3VyY2UgdHlwZWA7XG5cbiAgICAgIHJldC5wdXNoKG5vbkhvdHN3YXBwYWJsZUNoYW5nZShcbiAgICAgICAgdGhpcy5jaGFuZ2UsXG4gICAgICAgIHJlYXNvbixcbiAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgIHRoaXMubm9uSG90c3dhcHBhYmxlUHJvcHMsXG4gICAgICApKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0IG5hbWVzT2ZIb3Rzd2FwcGFibGVQcm9wcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuaG90c3dhcHBhYmxlUHJvcHMpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjbGFzc2lmeUNoYW5nZXMoeHM6IFJlc291cmNlQ2hhbmdlLCBob3Rzd2FwcGFibGVQcm9wTmFtZXM6IHN0cmluZ1tdKTogQ2xhc3NpZmllZENoYW5nZXMge1xuICBjb25zdCBob3Rzd2FwcGFibGVQcm9wczogUHJvcERpZmZzID0ge307XG4gIGNvbnN0IG5vbkhvdHN3YXBwYWJsZVByb3BzOiBQcm9wRGlmZnMgPSB7fTtcblxuICBmb3IgKGNvbnN0IFtuYW1lLCBwcm9wRGlmZl0gb2YgT2JqZWN0LmVudHJpZXMoeHMucHJvcGVydHlVcGRhdGVzKSkge1xuICAgIGlmIChob3Rzd2FwcGFibGVQcm9wTmFtZXMuaW5jbHVkZXMobmFtZSkpIHtcbiAgICAgIGhvdHN3YXBwYWJsZVByb3BzW25hbWVdID0gcHJvcERpZmY7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vbkhvdHN3YXBwYWJsZVByb3BzW25hbWVdID0gcHJvcERpZmY7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5ldyBDbGFzc2lmaWVkQ2hhbmdlcyh4cywgaG90c3dhcHBhYmxlUHJvcHMsIG5vbkhvdHN3YXBwYWJsZVByb3BzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vbkhvdHN3YXBwYWJsZUNoYW5nZShcbiAgY2hhbmdlOiBSZXNvdXJjZUNoYW5nZSxcbiAgcmVhc29uOiBOb25Ib3Rzd2FwcGFibGVSZWFzb24sXG4gIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gIG5vbkhvdHN3YXBwYWJsZVByb3BzPzogUHJvcERpZmZzLFxuICBob3Rzd2FwT25seVZpc2libGU6IGJvb2xlYW4gPSB0cnVlLFxuKTogUmVqZWN0ZWRDaGFuZ2Uge1xuICByZXR1cm4ge1xuICAgIGhvdHN3YXBwYWJsZTogZmFsc2UsXG4gICAgaG90c3dhcE9ubHlWaXNpYmxlLFxuICAgIGNoYW5nZToge1xuICAgICAgcmVhc29uLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBzdWJqZWN0OiB7XG4gICAgICAgIHR5cGU6ICdSZXNvdXJjZScsXG4gICAgICAgIGxvZ2ljYWxJZDogY2hhbmdlLmxvZ2ljYWxJZCxcbiAgICAgICAgcmVzb3VyY2VUeXBlOiBjaGFuZ2UubmV3VmFsdWUuVHlwZSxcbiAgICAgICAgcmVqZWN0ZWRQcm9wZXJ0aWVzOiBPYmplY3Qua2V5cyhub25Ib3Rzd2FwcGFibGVQcm9wcyA/PyBjaGFuZ2UucHJvcGVydHlVcGRhdGVzKSxcbiAgICAgICAgbWV0YWRhdGE6IGNoYW5nZS5tZXRhZGF0YSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vbkhvdHN3YXBwYWJsZVJlc291cmNlKGNoYW5nZTogUmVzb3VyY2VDaGFuZ2UpOiBSZWplY3RlZENoYW5nZSB7XG4gIHJldHVybiB7XG4gICAgaG90c3dhcHBhYmxlOiBmYWxzZSxcbiAgICBjaGFuZ2U6IHtcbiAgICAgIHJlYXNvbjogTm9uSG90c3dhcHBhYmxlUmVhc29uLlJFU09VUkNFX1VOU1VQUE9SVEVELFxuICAgICAgZGVzY3JpcHRpb246ICdUaGlzIHJlc291cmNlIHR5cGUgaXMgbm90IHN1cHBvcnRlZCBmb3IgaG90c3dhcCBkZXBsb3ltZW50cycsXG4gICAgICBzdWJqZWN0OiB7XG4gICAgICAgIHR5cGU6ICdSZXNvdXJjZScsXG4gICAgICAgIGxvZ2ljYWxJZDogY2hhbmdlLmxvZ2ljYWxJZCxcbiAgICAgICAgcmVzb3VyY2VUeXBlOiBjaGFuZ2UubmV3VmFsdWUuVHlwZSxcbiAgICAgICAgcmVqZWN0ZWRQcm9wZXJ0aWVzOiBPYmplY3Qua2V5cyhjaGFuZ2UucHJvcGVydHlVcGRhdGVzKSxcbiAgICAgICAgbWV0YWRhdGE6IGNoYW5nZS5tZXRhZGF0YSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfTtcbn1cbiJdfQ==