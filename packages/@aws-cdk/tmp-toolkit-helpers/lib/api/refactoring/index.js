"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ResourceMapping = exports.ResourceLocation = exports.AmbiguityError = void 0;
exports.resourceMovements = resourceMovements;
exports.ambiguousMovements = ambiguousMovements;
exports.resourceMappings = resourceMappings;
exports.findResourceMovements = findResourceMovements;
exports.formatTypedMappings = formatTypedMappings;
exports.formatAmbiguousMappings = formatAmbiguousMappings;
const cloudformation_diff_1 = require("@aws-cdk/cloudformation-diff");
const util_1 = require("../../util");
const plugin_1 = require("../plugin");
const streams_1 = require("../streams");
const digest_1 = require("./digest");
class AmbiguityError extends Error {
    movements;
    constructor(movements) {
        super('Ambiguous resource mappings');
        this.movements = movements;
    }
    paths() {
        return this.movements.map(([a, b]) => [convert(a), convert(b)]);
        function convert(locations) {
            return locations.map((l) => l.toPath());
        }
    }
}
exports.AmbiguityError = AmbiguityError;
/**
 * This class mirrors the `ResourceLocation` interface from CloudFormation,
 * but is richer, since it has a reference to the stack object, rather than
 * merely the stack name.
 */
class ResourceLocation {
    stack;
    logicalResourceId;
    constructor(stack, logicalResourceId) {
        this.stack = stack;
        this.logicalResourceId = logicalResourceId;
    }
    toPath() {
        const stack = this.stack;
        const resource = stack.template.Resources?.[this.logicalResourceId];
        const result = resource?.Metadata?.['aws:cdk:path'];
        if (result != null) {
            return result;
        }
        // If the path is not available, we can use stack name and logical ID
        return `${stack.stackName}.${this.logicalResourceId}`;
    }
    getType() {
        const resource = this.stack.template.Resources?.[this.logicalResourceId ?? ''];
        return resource?.Type ?? 'Unknown';
    }
    equalTo(other) {
        return this.logicalResourceId === other.logicalResourceId && this.stack.stackName === other.stack.stackName;
    }
}
exports.ResourceLocation = ResourceLocation;
/**
 * A mapping between a source and a destination location.
 */
class ResourceMapping {
    source;
    destination;
    constructor(source, destination) {
        this.source = source;
        this.destination = destination;
    }
    toTypedMapping() {
        return {
            // the type is the same in both source and destination,
            // so we can use either one
            type: this.source.getType(),
            sourcePath: this.source.toPath(),
            destinationPath: this.destination.toPath(),
        };
    }
}
exports.ResourceMapping = ResourceMapping;
function groupByKey(entries) {
    const result = {};
    for (const [hash, location] of entries) {
        if (hash in result) {
            result[hash].push(location);
        }
        else {
            result[hash] = [location];
        }
    }
    return result;
}
function resourceMovements(before, after) {
    return Object.values(removeUnmovedResources(zip(groupByKey(before.flatMap(resourceDigests)), groupByKey(after.flatMap(resourceDigests)))));
}
function ambiguousMovements(movements) {
    // A movement is considered ambiguous if these two conditions are met:
    //  1. Both sides have at least one element (otherwise, it's just addition or deletion)
    //  2. At least one side has more than one element
    return movements
        .filter(([pre, post]) => pre.length > 0 && post.length > 0)
        .filter(([pre, post]) => pre.length > 1 || post.length > 1);
}
/**
 * Converts a list of unambiguous resource movements into a list of resource mappings.
 *
 */
function resourceMappings(movements) {
    return movements
        .filter(([pre, post]) => pre.length === 1 && post.length === 1 && !pre[0].equalTo(post[0]))
        .map(([pre, post]) => new ResourceMapping(pre[0], post[0]));
}
function removeUnmovedResources(m) {
    const result = {};
    for (const [hash, [before, after]] of Object.entries(m)) {
        const common = before.filter((b) => after.some((a) => a.equalTo(b)));
        result[hash] = [
            before.filter((b) => !common.some((c) => b.equalTo(c))),
            after.filter((a) => !common.some((c) => a.equalTo(c))),
        ];
    }
    return result;
}
/**
 * For each hash, identifying a single resource, zip the two lists of locations,
 * producing a resource movement
 */
function zip(m1, m2) {
    const result = {};
    for (const [hash, locations] of Object.entries(m1)) {
        if (hash in m2) {
            result[hash] = [locations, m2[hash]];
        }
        else {
            result[hash] = [locations, []];
        }
    }
    for (const [hash, locations] of Object.entries(m2)) {
        if (!(hash in m1)) {
            result[hash] = [[], locations];
        }
    }
    return result;
}
/**
 * Computes a list of pairs [digest, location] for each resource in the stack.
 */
function resourceDigests(stack) {
    const digests = (0, digest_1.computeResourceDigests)(stack.template);
    return Object.entries(digests).map(([logicalId, digest]) => {
        const location = new ResourceLocation(stack, logicalId);
        return [digest, location];
    });
}
/**
 * Compares the deployed state to the cloud assembly state, and finds all resources
 * that were moved from one location (stack + logical ID) to another. The comparison
 * is done per environment.
 */
async function findResourceMovements(stacks, sdkProvider) {
    const stackGroups = new Map();
    // Group stacks by environment
    for (const stack of stacks) {
        const environment = stack.environment;
        const key = (0, digest_1.hashObject)(environment);
        if (stackGroups.has(key)) {
            stackGroups.get(key)[1].push(stack);
        }
        else {
            // The first time we see an environment, we need to fetch all stacks deployed to it.
            const before = await getDeployedStacks(sdkProvider, environment);
            stackGroups.set(key, [before, [stack]]);
        }
    }
    const result = [];
    for (const [_, [before, after]] of stackGroups) {
        result.push(...resourceMovements(before, after));
    }
    return result;
}
async function getDeployedStacks(sdkProvider, environment) {
    const cfn = (await sdkProvider.forEnvironment(environment, plugin_1.Mode.ForReading)).sdk.cloudFormation();
    const summaries = await cfn.paginatedListStacks({
        StackStatusFilter: [
            'CREATE_COMPLETE',
            'UPDATE_COMPLETE',
            'UPDATE_ROLLBACK_COMPLETE',
            'IMPORT_COMPLETE',
            'ROLLBACK_COMPLETE',
        ],
    });
    const normalize = async (summary) => {
        const templateCommandOutput = await cfn.getTemplate({ StackName: summary.StackName });
        const template = (0, util_1.deserializeStructure)(templateCommandOutput.TemplateBody ?? '{}');
        return {
            environment,
            stackName: summary.StackName,
            template,
        };
    };
    // eslint-disable-next-line @cdklabs/promiseall-no-unbounded-parallelism
    return Promise.all(summaries.map(normalize));
}
function formatTypedMappings(mappings) {
    const stream = new streams_1.StringWriteStream();
    (0, cloudformation_diff_1.formatTypedMappings)(stream, mappings);
    return stream.toString();
}
function formatAmbiguousMappings(paths) {
    const stream = new streams_1.StringWriteStream();
    (0, cloudformation_diff_1.formatAmbiguousMappings)(stream, paths);
    return stream.toString();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYXBpL3JlZmFjdG9yaW5nL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQW1HQSw4Q0FNQztBQUVELGdEQU9DO0FBTUQsNENBSUM7QUE2REQsc0RBd0JDO0FBZ0NELGtEQUlDO0FBRUQsMERBSUM7QUExUEQsc0VBR3NDO0FBR3RDLHFDQUFrRDtBQUVsRCxzQ0FBaUM7QUFDakMsd0NBQStDO0FBRS9DLHFDQUE4RDtBQVM5RCxNQUFhLGNBQWUsU0FBUSxLQUFLO0lBQ1g7SUFBNUIsWUFBNEIsU0FBNkI7UUFDdkQsS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFEWCxjQUFTLEdBQVQsU0FBUyxDQUFvQjtJQUV6RCxDQUFDO0lBRU0sS0FBSztRQUNWLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVoRSxTQUFTLE9BQU8sQ0FBQyxTQUE2QjtZQUM1QyxPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQzFDLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFaRCx3Q0FZQztBQUVEOzs7O0dBSUc7QUFDSCxNQUFhLGdCQUFnQjtJQUNOO0lBQXFDO0lBQTFELFlBQXFCLEtBQTBCLEVBQVcsaUJBQXlCO1FBQTlELFVBQUssR0FBTCxLQUFLLENBQXFCO1FBQVcsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFRO0lBQ25GLENBQUM7SUFFTSxNQUFNO1FBQ1gsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN6QixNQUFNLFFBQVEsR0FBRyxL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O0FBQy9DLENBQUM7QUFFRCxTQUFnQixtQkFBbUIsQ0FBQyxRQUF3QjtJQUMxRCxNQUFNLE1BQU0sR0FBRyxJQUFJLDJCQUFpQixFQUFFLENBQUM7SUFDdkMsSUFBQSx5Q0FBZ0IsRUFBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDbkMsT0FBTyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDM0IsQ0FBQztBQUVELFNBQWdCLHVCQUF1QixDQUFDLEtBQTZCO0lBQ25FLE1BQU0sTUFBTSxHQUFHLElBQUksMkJBQWlCLEVBQUUsQ0FBQztJQUN2QyxJQUFBLDZDQUFvQixFQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwQyxPQUFPLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUMzQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBUeXBlZE1hcHBpbmcgfSBmcm9tICdAYXdzLWNkay9jbG91ZGZvcm1hdGlvbi1kaWZmJztcbmltcG9ydCB7XG4gIGZvcm1hdEFtYmlndW91c01hcHBpbmdzIGFzIGZtdEFtYmlndW91c01hcHBpbmdzLFxuICBmb3JtYXRUeXBlZE1hcHBpbmdzIGFzIGZtdFR5cGVkTWFwcGluZ3MsXG59IGZyb20gJ0Bhd3MtY2RrL2Nsb3VkZm9ybWF0aW9uLWRpZmYnO1xuaW1wb3J0IHR5cGUgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHR5cGUgeyBTdGFja1N1bW1hcnkgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHsgZGVzZXJpYWxpemVTdHJ1Y3R1cmUgfSBmcm9tICcuLi8uLi91dGlsJztcbmltcG9ydCB0eXBlIHsgU2RrUHJvdmlkZXIgfSBmcm9tICcuLi9hd3MtYXV0aCc7XG5pbXBvcnQgeyBNb2RlIH0gZnJvbSAnLi4vcGx1Z2luJztcbmltcG9ydCB7IFN0cmluZ1dyaXRlU3RyZWFtIH0gZnJvbSAnLi4vc3RyZWFtcyc7XG5pbXBvcnQgdHlwZSB7IENsb3VkRm9ybWF0aW9uU3RhY2sgfSBmcm9tICcuL2Nsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IGNvbXB1dGVSZXNvdXJjZURpZ2VzdHMsIGhhc2hPYmplY3QgfSBmcm9tICcuL2RpZ2VzdCc7XG5cbi8qKlxuICogUmVwcmVzZW50cyBhIHNldCBvZiBwb3NzaWJsZSBtb3ZlbWVudHMgb2YgYSByZXNvdXJjZSBmcm9tIG9uZSBsb2NhdGlvblxuICogdG8gYW5vdGhlci4gSW4gdGhlIGlkZWFsIGNhc2UsIHRoZXJlIGlzIG9ubHkgb25lIHNvdXJjZSBhbmQgb25seSBvbmVcbiAqIGRlc3RpbmF0aW9uLlxuICovXG5leHBvcnQgdHlwZSBSZXNvdXJjZU1vdmVtZW50ID0gW1Jlc291cmNlTG9jYXRpb25bXSwgUmVzb3VyY2VMb2NhdGlvbltdXTtcblxuZXhwb3J0IGNsYXNzIEFtYmlndWl0eUVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgbW92ZW1lbnRzOiBSZXNvdXJjZU1vdmVtZW50W10pIHtcbiAgICBzdXBlcignQW1iaWd1b3VzIHJlc291cmNlIG1hcHBpbmdzJyk7XG4gIH1cblxuICBwdWJsaWMgcGF0aHMoKTogW3N0cmluZ1tdLCBzdHJpbmdbXV1bXSB7XG4gICAgcmV0dXJuIHRoaXMubW92ZW1lbnRzLm1hcCgoW2EsIGJdKSA9PiBbY29udmVydChhKSwgY29udmVydChiKV0pO1xuXG4gICAgZnVuY3Rpb24gY29udmVydChsb2NhdGlvbnM6IFJlc291cmNlTG9jYXRpb25bXSk6IHN0cmluZ1tdIHtcbiAgICAgIHJldHVybiBsb2NhdGlvbnMubWFwKChsKSA9PiBsLnRvUGF0aCgpKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBUaGlzIGNsYXNzIG1pcnJvcnMgdGhlIGBSZXNvdXJjZUxvY2F0aW9uYCBpbnRlcmZhY2UgZnJvbSBDbG91ZEZvcm1hdGlvbixcbiAqIGJ1dCBpcyByaWNoZXIsIHNpbmNlIGl0IGhhcyBhIHJlZmVyZW5jZSB0byB0aGUgc3RhY2sgb2JqZWN0LCByYXRoZXIgdGhhblxuICogbWVyZWx5IHRoZSBzdGFjayBuYW1lLlxuICovXG5leHBvcnQgY2xhc3MgUmVzb3VyY2VMb2NhdGlvbiB7XG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHN0YWNrOiBDbG91ZEZvcm1hdGlvblN0YWNrLCByZWFkb25seSBsb2dpY2FsUmVzb3VyY2VJZDogc3RyaW5nKSB7XG4gIH1cblxuICBwdWJsaWMgdG9QYXRoKCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RhY2sgPSB0aGlzLnN0YWNrO1xuICAgIGNvbnN0IHJlc291cmNlID0gc3RhY2sudGVtcGxhdGUuUmVzb3VyY2VzPy5bdGhpcy5sb2dpY2FsUmVzb3VyY2VJZF07XG4gICAgY29uc3QgcmVzdWx0ID0gcmVzb3VyY2U/Lk1ldGFkYXRhPy5bJ2F3czpjZGs6cGF0aCddO1xuXG4gICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8vIElmIHRoZSBwYXRoIGlzIG5vdCBhdmFpbGFibGUsIHdlIGNhbiB1c2Ugc3RhY2sgbmFtZSBhbmQgbG9naWNhbCBJRFxuICAgIHJldHVybiBgJHtzdGFjay5zdGFja05hbWV9LiR7dGhpcy5sb2dpY2FsUmVzb3VyY2VJZH1gO1xuICB9XG5cbiAgcHVibGljIGdldFR5cGUoKTogc3RyaW5nIHtcbiAgICBjb25zdCByZXNvdXJjZSA9IHRoaXMuc3RhY2sudGVtcGxhdGUuUmVzb3VyY2VzPy5bdGhpcy5sb2dpY2FsUmVzb3VyY2VJZCA/PyAnJ107XG4gICAgcmV0dXJuIHJlc291cmNlPy5UeXBlID8/ICdVbmtub3duJztcbiAgfVxuXG4gIHB1YmxpYyBlcXVhbFRvKG90aGVyOiBSZXNvdXJjZUxvY2F0aW9uKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubG9naWNhbFJlc291cmNlSWQgPT09IG90aGVyLmxvZ2ljYWxSZXNvdXJjZUlkICYmIHRoaXMuc3RhY2suc3RhY2tOYW1lID09PSBvdGhlci5zdGFjay5zdGFja05hbWU7XG4gIH1cbn1cblxuLyoqXG4gKiBBIG1hcHBpbmcgYmV0d2VlbiBhIHNvdXJjZSBhbmQgYSBkZXN0aW5hdGlvbiBsb2NhdGlvbi5cbiAqL1xuZXhwb3J0IGNsYXNzIFJlc291cmNlTWFwcGluZyB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBzb3VyY2U6IFJlc291cmNlTG9jYXRpb24sIHB1YmxpYyByZWFkb25seSBkZXN0aW5hdGlvbjogUmVzb3VyY2VMb2NhdGlvbikge1xuICB9XG5cbiAgcHVibGljIHRvVHlwZWRNYXBwaW5nKCk6IFR5cGVkTWFwcGluZyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC8vIHRoZSB0eXBlIGlzIHRoZSBzYW1lIGluIGJvdGggc291cmNlIGFuZCBkZXN0aW5hdGlvbixcbiAgICAgIC8vIHNvIHdlIGNhbiB1c2UgZWl0aGVyIG9uZVxuICAgICAgdHlwZTogdGhpcy5zb3VyY2UuZ2V0VHlwZSgpLFxuICAgICAgc291cmNlUGF0aDogdGhpcy5zb3VyY2UudG9QYXRoKCksXG4gICAgICBkZXN0aW5hdGlvblBhdGg6IHRoaXMuZGVzdGluYXRpb24udG9QYXRoKCksXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBncm91cEJ5S2V5PEE+KGVudHJpZXM6IFtzdHJpbmcsIEFdW10pOiBSZWNvcmQ8c3RyaW5nLCBBW10+IHtcbiAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBBW10+ID0ge307XG5cbiAgZm9yIChjb25zdCBbaGFzaCwgbG9jYXRpb25dIG9mIGVudHJpZXMpIHtcbiAgICBpZiAoaGFzaCBpbiByZXN1bHQpIHtcbiAgICAgIHJlc3VsdFtoYXNoXS5wdXNoKGxvY2F0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0W2hhc2hdID0gW2xvY2F0aW9uXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzb3VyY2VNb3ZlbWVudHMoYmVmb3JlOiBDbG91ZEZvcm1hdGlvblN0YWNrW10sIGFmdGVyOiBDbG91ZEZvcm1hdGlvblN0YWNrW10pOiBSZXNvdXJjZU1vdmVtZW50W10ge1xuICByZXR1cm4gT2JqZWN0LnZhbHVlcyhcbiAgICByZW1vdmVVbm1vdmVkUmVzb3VyY2VzKFxuICAgICAgemlwKGdyb3VwQnlLZXkoYmVmb3JlLmZsYXRNYXAocmVzb3VyY2VEaWdlc3RzKSksIGdyb3VwQnlLZXkoYWZ0ZXIuZmxhdE1hcChyZXNvdXJjZURpZ2VzdHMpKSksXG4gICAgKSxcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFtYmlndW91c01vdmVtZW50cyhtb3ZlbWVudHM6IFJlc291cmNlTW92ZW1lbnRbXSkge1xuICAvLyBBIG1vdmVtZW50IGlzIGNvbnNpZGVyZWQgYW1iaWd1b3VzIGlmIHRoZXNlIHR3byBjb25kaXRpb25zIGFyZSBtZXQ6XG4gIC8vICAxLiBCb3RoIHNpZGVzIGhhdmUgYXQgbGVhc3Qgb25lIGVsZW1lbnQgKG90aGVyd2lzZSwgaXQncyBqdXN0IGFkZGl0aW9uIG9yIGRlbGV0aW9uKVxuICAvLyAgMi4gQXQgbGVhc3Qgb25lIHNpZGUgaGFzIG1vcmUgdGhhbiBvbmUgZWxlbWVudFxuICByZXR1cm4gbW92ZW1lbnRzXG4gICAgLmZpbHRlcigoW3ByZSwgcG9zdF0pID0+IHByZS5sZW5ndGggPiAwICYmIHBvc3QubGVuZ3RoID4gMClcbiAgICAuZmlsdGVyKChbcHJlLCBwb3N0XSkgPT4gcHJlLmxlbmd0aCA+IDEgfHwgcG9zdC5sZW5ndGggPiAxKTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0cyBhIGxpc3Qgb2YgdW5hbWJpZ3VvdXMgcmVzb3VyY2UgbW92ZW1lbnRzIGludG8gYSBsaXN0IG9mIHJlc291cmNlIG1hcHBpbmdzLlxuICpcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlc291cmNlTWFwcGluZ3MobW92ZW1lbnRzOiBSZXNvdXJjZU1vdmVtZW50W10pOiBSZXNvdXJjZU1hcHBpbmdbXSB7XG4gIHJldHVybiBtb3ZlbWVudHNcbiAgICAuZmlsdGVyKChbcHJlLCBwb3N0XSkgPT4gcHJlLmxlbmd0aCA9PT0gMSAmJiBwb3N0Lmxlbmd0aCA9PT0gMSAmJiAhcHJlWzBdLmVxdWFsVG8ocG9zdFswXSkpXG4gICAgLm1hcCgoW3ByZSwgcG9zdF0pID0+IG5ldyBSZXNvdXJjZU1hcHBpbmcocHJlWzBdLCBwb3N0WzBdKSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZVVubW92ZWRSZXNvdXJjZXMoXG4gIG06IFJlY29yZDxzdHJpbmcsIFJlc291cmNlTW92ZW1lbnQ+LFxuKTogUmVjb3JkPHN0cmluZywgUmVzb3VyY2VNb3ZlbWVudD4ge1xuICBjb25zdCByZXN1bHQ6IFJlY29yZDxzdHJpbmcsIFJlc291cmNlTW92ZW1lbnQ+ID0ge307XG4gIGZvciAoY29uc3QgW2hhc2gsIFtiZWZvcmUsIGFmdGVyXV0gb2YgT2JqZWN0LmVudHJpZXMobSkpIHtcbiAgICBjb25zdCBjb21tb24gPSBiZWZvcmUuZmlsdGVyKChiKSA9PiBhZnRlci5zb21lKChhKSA9PiBhLmVxdWFsVG8oYikpKTtcbiAgICByZXN1bHRbaGFzaF0gPSBbXG4gICAgICBiZWZvcmUuZmlsdGVyKChiKSA9PiAhY29tbW9uLnNvbWUoKGMpID0+IGIuZXF1YWxUbyhjKSkpLFxuICAgICAgYWZ0ZXIuZmlsdGVyKChhKSA9PiAhY29tbW9uLnNvbWUoKGMpID0+IGEuZXF1YWxUbyhjKSkpLFxuICAgIF07XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIEZvciBlYWNoIGhhc2gsIGlkZW50aWZ5aW5nIGEgc2luZ2xlIHJlc291cmNlLCB6aXAgdGhlIHR3byBsaXN0cyBvZiBsb2NhdGlvbnMsXG4gKiBwcm9kdWNpbmcgYSByZXNvdXJjZSBtb3ZlbWVudFxuICovXG5mdW5jdGlvbiB6aXAoXG4gIG0xOiBSZWNvcmQ8c3RyaW5nLCBSZXNvdXJjZUxvY2F0aW9uW10+LFxuICBtMjogUmVjb3JkPHN0cmluZywgUmVzb3VyY2VMb2NhdGlvbltdPixcbik6IFJlY29yZDxzdHJpbmcsIFJlc291cmNlTW92ZW1lbnQ+IHtcbiAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBSZXNvdXJjZU1vdmVtZW50PiA9IHt9O1xuXG4gIGZvciAoY29uc3QgW2hhc2gsIGxvY2F0aW9uc10gb2YgT2JqZWN0LmVudHJpZXMobTEpKSB7XG4gICAgaWYgKGhhc2ggaW4gbTIpIHtcbiAgICAgIHJlc3VsdFtoYXNoXSA9IFtsb2NhdGlvbnMsIG0yW2hhc2hdXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0W2hhc2hdID0gW2xvY2F0aW9ucywgW11dO1xuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgW2hhc2gsIGxvY2F0aW9uc10gb2YgT2JqZWN0LmVudHJpZXMobTIpKSB7XG4gICAgaWYgKCEoaGFzaCBpbiBtMSkpIHtcbiAgICAgIHJlc3VsdFtoYXNoXSA9IFtbXSwgbG9jYXRpb25zXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIENvbXB1dGVzIGEgbGlzdCBvZiBwYWlycyBbZGlnZXN0LCBsb2NhdGlvbl0gZm9yIGVhY2ggcmVzb3VyY2UgaW4gdGhlIHN0YWNrLlxuICovXG5mdW5jdGlvbiByZXNvdXJjZURpZ2VzdHMoc3RhY2s6IENsb3VkRm9ybWF0aW9uU3RhY2spOiBbc3RyaW5nLCBSZXNvdXJjZUxvY2F0aW9uXVtdIHtcbiAgY29uc3QgZGlnZXN0cyA9IGNvbXB1dGVSZXNvdXJjZURpZ2VzdHMoc3RhY2sudGVtcGxhdGUpO1xuXG4gIHJldHVybiBPYmplY3QuZW50cmllcyhkaWdlc3RzKS5tYXAoKFtsb2dpY2FsSWQsIGRpZ2VzdF0pID0+IHtcbiAgICBjb25zdCBsb2NhdGlvbjogUmVzb3VyY2VMb2NhdGlvbiA9IG5ldyBSZXNvdXJjZUxvY2F0aW9uKHN0YWNrLCBsb2dpY2FsSWQpO1xuICAgIHJldHVybiBbZGlnZXN0LCBsb2NhdGlvbl07XG4gIH0pO1xufVxuXG4vKipcbiAqIENvbXBhcmVzIHRoZSBkZXBsb3llZCBzdGF0ZSB0byB0aGUgY2xvdWQgYXNzZW1ibHkgc3RhdGUsIGFuZCBmaW5kcyBhbGwgcmVzb3VyY2VzXG4gKiB0aGF0IHdlcmUgbW92ZWQgZnJvbSBvbmUgbG9jYXRpb24gKHN0YWNrICsgbG9naWNhbCBJRCkgdG8gYW5vdGhlci4gVGhlIGNvbXBhcmlzb25cbiAqIGlzIGRvbmUgcGVyIGVudmlyb25tZW50LlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmluZFJlc291cmNlTW92ZW1lbnRzKFxuICBzdGFja3M6IENsb3VkRm9ybWF0aW9uU3RhY2tbXSxcbiAgc2RrUHJvdmlkZXI6IFNka1Byb3ZpZGVyLFxuKTogUHJvbWlzZTxSZXNvdXJjZU1vdmVtZW50W10+IHtcbiAgY29uc3Qgc3RhY2tHcm91cHM6IE1hcDxzdHJpbmcsIFtDbG91ZEZvcm1hdGlvblN0YWNrW10sIENsb3VkRm9ybWF0aW9uU3RhY2tbXV0+ID0gbmV3IE1hcCgpO1xuXG4gIC8vIEdyb3VwIHN0YWNrcyBieSBlbnZpcm9ubWVudFxuICBmb3IgKGNvbnN0IHN0YWNrIG9mIHN0YWNrcykge1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gc3RhY2suZW52aXJvbm1lbnQ7XG4gICAgY29uc3Qga2V5ID0gaGFzaE9iamVjdChlbnZpcm9ubWVudCk7XG4gICAgaWYgKHN0YWNrR3JvdXBzLmhhcyhrZXkpKSB7XG4gICAgICBzdGFja0dyb3Vwcy5nZXQoa2V5KSFbMV0ucHVzaChzdGFjayk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoZSBmaXJzdCB0aW1lIHdlIHNlZSBhbiBlbnZpcm9ubWVudCwgd2UgbmVlZCB0byBmZXRjaCBhbGwgc3RhY2tzIGRlcGxveWVkIHRvIGl0LlxuICAgICAgY29uc3QgYmVmb3JlID0gYXdhaXQgZ2V0RGVwbG95ZWRTdGFja3Moc2RrUHJvdmlkZXIsIGVudmlyb25tZW50KTtcbiAgICAgIHN0YWNrR3JvdXBzLnNldChrZXksIFtiZWZvcmUsIFtzdGFja11dKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCByZXN1bHQ6IFJlc291cmNlTW92ZW1lbnRbXSA9IFtdO1xuICBmb3IgKGNvbnN0IFtfLCBbYmVmb3JlLCBhZnRlcl1dIG9mIHN0YWNrR3JvdXBzKSB7XG4gICAgcmVzdWx0LnB1c2goLi4ucmVzb3VyY2VNb3ZlbWVudHMoYmVmb3JlLCBhZnRlcikpO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERlcGxveWVkU3RhY2tzKFxuICBzZGtQcm92aWRlcjogU2RrUHJvdmlkZXIsXG4gIGVudmlyb25tZW50OiBjeGFwaS5FbnZpcm9ubWVudCxcbik6IFByb21pc2U8Q2xvdWRGb3JtYXRpb25TdGFja1tdPiB7XG4gIGNvbnN0IGNmbiA9IChhd2FpdCBzZGtQcm92aWRlci5mb3JFbnZpcm9ubWVudChlbnZpcm9ubWVudCwgTW9kZS5Gb3JSZWFkaW5nKSkuc2RrLmNsb3VkRm9ybWF0aW9uKCk7XG5cbiAgY29uc3Qgc3VtbWFyaWVzID0gYXdhaXQgY2ZuLnBhZ2luYXRlZExpc3RTdGFja3Moe1xuICAgIFN0YWNrU3RhdHVzRmlsdGVyOiBbXG4gICAgICAnQ1JFQVRFX0NPTVBMRVRFJyxcbiAgICAgICdVUERBVEVfQ09NUExFVEUnLFxuICAgICAgJ1VQREFURV9ST0xMQkFDS19DT01QTEVURScsXG4gICAgICAnSU1QT1JUX0NPTVBMRVRFJyxcbiAgICAgICdST0xMQkFDS19DT01QTEVURScsXG4gICAgXSxcbiAgfSk7XG5cbiAgY29uc3Qgbm9ybWFsaXplID0gYXN5bmMgKHN1bW1hcnk6IFN0YWNrU3VtbWFyeSkgPT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlQ29tbWFuZE91dHB1dCA9IGF3YWl0IGNmbi5nZXRUZW1wbGF0ZSh7IFN0YWNrTmFtZTogc3VtbWFyeS5TdGFja05hbWUhIH0pO1xuICAgIGNvbnN0IHRlbXBsYXRlID0gZGVzZXJpYWxpemVTdHJ1Y3R1cmUodGVtcGxhdGVDb21tYW5kT3V0cHV0LlRlbXBsYXRlQm9keSA/PyAne30nKTtcbiAgICByZXR1cm4ge1xuICAgICAgZW52aXJvbm1lbnQsXG4gICAgICBzdGFja05hbWU6IHN1bW1hcnkuU3RhY2tOYW1lISxcbiAgICAgIHRlbXBsYXRlLFxuICAgIH07XG4gIH07XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBjZGtsYWJzL3Byb21pc2VhbGwtbm8tdW5ib3VuZGVkLXBhcmFsbGVsaXNtXG4gIHJldHVybiBQcm9taXNlLmFsbChzdW1tYXJpZXMubWFwKG5vcm1hbGl6ZSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0VHlwZWRNYXBwaW5ncyhtYXBwaW5nczogVHlwZWRNYXBwaW5nW10pOiBzdHJpbmcge1xuICBjb25zdCBzdHJlYW0gPSBuZXcgU3RyaW5nV3JpdGVTdHJlYW0oKTtcbiAgZm10VHlwZWRNYXBwaW5ncyhzdHJlYW0sIG1hcHBpbmdzKTtcbiAgcmV0dXJuIHN0cmVhbS50b1N0cmluZygpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0QW1iaWd1b3VzTWFwcGluZ3MocGF0aHM6IFtzdHJpbmdbXSwgc3RyaW5nW11dW10pOiBzdHJpbmcge1xuICBjb25zdCBzdHJlYW0gPSBuZXcgU3RyaW5nV3JpdGVTdHJlYW0oKTtcbiAgZm10QW1iaWd1b3VzTWFwcGluZ3Moc3RyZWFtLCBwYXRocyk7XG4gIHJldHVybiBzdHJlYW0udG9TdHJpbmcoKTtcbn1cbiJdfQ==